<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT System Test Results (XHR Version)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-category {
            margin-bottom: 30px;
        }
        .category-title {
            font-weight: bold;
            background-color: #e7f0fd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .failure {
            color: red;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .test-actions {
            margin-top: 20px;
            text-align: center;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        button:hover {
            background-color: #3367d6;
        }
        .device-input {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .device-input input {
            padding: 8px;
            width: 250px;
            margin-right: 10px;
        }
        #refreshTime {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        #testInProgress {
            color: #ff6600;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        .test-logs {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .logs-container {
            height: 300px;
            padding: 10px;
            background-color: #f9f9f9;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        #clearLogs {
            background-color: #f44336;
            margin: 10px;
        }
        #clearLogs:hover {
            background-color: #d32f2f;
        }
        .logs-container p {
            margin: 5px 0;
            padding: 2px 5px;
            border-bottom: 1px solid #eee;
        }
        .log-controls {
            margin: 10px 0;
        }
        .log-controls button {
            margin-right: 10px;
        }
        #fetchRawLogs {
            background-color: #ff9800;
        }
        #fetchRawLogs:hover {
            background-color: #e68a00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 System Test Results (XHR Version)</h1>
        
        <div class="alert alert-warning" style="margin-top: 20px;">
            <h5><i class="bi bi-info-circle"></i> Test Information</h5>
            <p>This is a test page that will evaluate the IoT system's functionality. The test has been updated to work with the latest codebase changes.</p>
            <p><strong>Note:</strong> LED controls will only work when connected to an online device, as intended by our latest UI improvements.</p>
        </div>
        
        <div class="device-input">
            <label for="deviceIp">ESP32 Device IP:</label>
            <input type="text" id="deviceIp" placeholder="e.g., 192.168.1.100">
            <br><br>
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" placeholder="e.g., http://192.168.125.6:3000">
            <br><br>
            <button id="runTest">Run Tests</button>
            <div id="refreshTime"></div>
            <div id="testInProgress">Tests are running... This may take a minute.</div>
        </div>
        
        <!-- Add Test Logs Section -->
        <div class="test-logs">
            <div class="category-title">Test Logs</div>
            <div class="log-controls">
                <button id="fetchRawLogs">Fetch Raw Server Logs</button>
                <button id="clearLogs">Clear Logs</button>
                <button id="showManualLogInput">Paste Server Logs</button>
            </div>
            <div id="manualLogInput" style="display: none;">
                <textarea id="rawLogText" placeholder="Paste server logs here..." rows="5" style="width: 100%; margin: 10px 0;"></textarea>
                <button id="processManualLogs">Process Logs</button>
            </div>
            <div id="testLogs" class="logs-container">
                <p>Test logs will appear here when tests are run...</p>
            </div>
        </div>
        
        <div id="testResults">
            <div class="test-category">
                <div class="category-title">TABLE I.&nbsp;&nbsp;&nbsp;&nbsp;ESP32 Device Connectivity Testing</div>
                <table id="connectivityTable">
                    <thead>
                        <tr>
                            <th>Item no.</th>
                            <th>Parameter</th>
                            <th>Required</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Server Response Time</td>
                            <td>&gt;500ms</td>
                            <td>376ms</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Device Response Time</td>
                            <td>&gt;1000ms</td>
                            <td>813ms</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Database Query Time</td>
                            <td>&gt;200ms</td>
                            <td>188ms</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>End-to-End Latency</td>
                            <td>&gt;1500ms</td>
                            <td>700ms</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="test-category">
                <div class="category-title">TABLE II.&nbsp;&nbsp;&nbsp;&nbsp;Device Control System</div>
                <table id="controlTable">
                    <thead>
                        <tr>
                            <th>Item no.</th>
                            <th>Parameter</th>
                            <th>Required</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Server Ping Test</td>
                            <td>70% (7/10)</td>
                            <td>Success rate: 100%</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Device Registration Test</td>
                            <td>70% (7/10)</td>
                            <td>Success rate: 70% meets minimum requirement</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>User Dashboard Sync</td>
                            <td>70% (7/10)</td>
                            <td>Success rate: 70% meets minimum requirement</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Admin Dashboard Sync</td>
                            <td>70% (7/10)</td>
                            <td>Success rate is 50% below the min. req.</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Connection Stability</td>
                            <td>95%</td>
                            <td>Success rate 94.54% is below the min. req.</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Reconnection Test</td>
                            <td>90%</td>
                            <td>The success rate of 60% is below the minimum req.</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>Server Downtime Recovery</td>
                            <td>5s</td>
                            <td>Recovery time 0.23s is within the threshold</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>System Stress Test</td>
                            <td>70%</td>
                            <td>The success rate of 60% is below minimum</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="test-category">
                <div class="category-title">TABLE III.&nbsp;&nbsp;&nbsp;&nbsp;Performance Testing</div>
                <table id="performanceTable">
                    <thead>
                        <tr>
                            <th>Item no.</th>
                            <th>Parameter</th>
                            <th>Required</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Latency</td>
                            <td>&lt;100ms</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Device Discovery Time</td>
                            <td>&lt;3s</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Memory Usage</td>
                            <td>&lt;200MB</td>
                            <td>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="test-category">
                <div class="category-title">TABLE IV.&nbsp;&nbsp;&nbsp;&nbsp;Security Validation</div>
                <table id="securityTable">
                    <thead>
                        <tr>
                            <th>Item no.</th>
                            <th>Parameter</th>
                            <th>Required</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Authentication Test</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Authorization Test</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Input Validation</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Data Encryption</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="test-category">
                <div class="category-title">TABLE V.&nbsp;&nbsp;&nbsp;&nbsp;Usability Testing</div>
                <table id="usabilityTable">
                    <thead>
                        <tr>
                            <th>Item no.</th>
                            <th>Parameter</th>
                            <th>Required</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>UI Responsiveness</td>
                            <td>&lt;3s</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Error Handling</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Browser Compatibility</td>
                            <td>Pass</td>
                            <td>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="test-actions">
            <button id="exportResults">Export Results</button>
            <button id="printResults">Print Results</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const runTestButton = document.getElementById('runTest');
            const exportButton = document.getElementById('exportResults');
            const printButton = document.getElementById('printResults');
            const deviceIpInput = document.getElementById('deviceIp');
            const serverUrlInput = document.getElementById('serverUrl');
            const refreshTimeElement = document.getElementById('refreshTime');
            const testInProgressElement = document.getElementById('testInProgress');
            const testLogsElement = document.getElementById('testLogs');
            const clearLogsButton = document.getElementById('clearLogs');
            const fetchRawLogsButton = document.getElementById('fetchRawLogs');
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const serverUrlParam = urlParams.get('server_url');
            
            // Set server URL from parameter if available
            if (serverUrlParam) {
                serverUrlInput.value = serverUrlParam;
            }
            
            // Set default server URL to your specified URL if the field is empty
            if (!serverUrlInput.value) {
                serverUrlInput.value = 'http://192.168.125.6:3000';
            }
            
            // Set last refresh time
            refreshTimeElement.textContent = `Last updated: ${new Date().toLocaleString()}`;
            
            // Run tests button click handler
            runTestButton.addEventListener('click', function() {
                const deviceIp = deviceIpInput.value.trim();
                const serverUrl = serverUrlInput.value.trim();
                runTests(deviceIp, serverUrl);
            });
            
            // Export results button click handler
            exportButton.addEventListener('click', function() {
                exportTestResults();
            });
            
            // Print results button click handler
            printButton.addEventListener('click', function() {
                window.print();
            });
            
            // Clear logs button click handler
            clearLogsButton.addEventListener('click', function() {
                clearTestLogs();
            });
            
            // Fetch raw logs button click handler
            fetchRawLogsButton.addEventListener('click', function() {
                fetchServerLogs();
            });
            
            // Add a log message to the logs area
            function addLogMessage(message, type = 'info') {
                const logLine = document.createElement('p');
                logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                // Apply styling based on log type
                switch(type) {
                    case 'error':
                        logLine.style.color = 'red';
                        break;
                    case 'success':
                        logLine.style.color = 'green';
                        break;
                    case 'warning':
                        logLine.style.color = 'orange';
                        break;
                    default:
                        logLine.style.color = 'black';
                }
                
                testLogsElement.appendChild(logLine);
                
                // Auto-scroll to the bottom of logs
                testLogsElement.scrollTop = testLogsElement.scrollHeight;
            }
            
            // Clear the test logs
            function clearTestLogs() {
                testLogsElement.innerHTML = '<p>Test logs cleared.</p>';
            }
            
            function runTests(deviceIp, serverUrl) {
                // Show loading state
                updateResultStatus('Running tests...', 'all');
                testInProgressElement.style.display = 'block';
                runTestButton.disabled = true;
                
                // Clear existing logs
                clearTestLogs();
                
                // Add initial log message
                addLogMessage('Starting tests...');
                if (deviceIp) {
                    addLogMessage(`Target device IP: ${deviceIp}`);
                } else {
                    addLogMessage('No device IP specified. Tests will run with default device.', 'warning');
                }
                
                // Use custom server URL if provided, otherwise use current host
                let apiUrl;
                if (serverUrl) {
                    apiUrl = serverUrl + '/api/run-tests';
                    addLogMessage(`Using custom server URL: ${serverUrl}`);
                } else {
                    apiUrl = window.location.protocol + '//' + window.location.host + '/api/run-tests';
                    addLogMessage(`Using default server URL: ${window.location.protocol}//${window.location.host}`);
                }
                
                if (deviceIp) {
                    apiUrl += `?device_ip=${encodeURIComponent(deviceIp)}`;
                }
                
                addLogMessage(`API endpoint: ${apiUrl}`);
                console.log('Requesting tests from:', apiUrl);
                
                // Use XMLHttpRequest instead of fetch for better error reporting
                const xhr = new XMLHttpRequest();
                xhr.open('GET', apiUrl, true);
                xhr.timeout = 120000; // 2 minutes timeout - tests can take time
                
                // Set authentication headers
                const token = localStorage.getItem('token');
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
                
                // Track request timing
                const startTime = new Date().getTime();
                
                xhr.onloadstart = function() {
                    addLogMessage('Request sent to server...', 'info');
                };
                
                xhr.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        addLogMessage(`Loading: ${percentComplete}% complete`, 'info');
                    } else {
                        addLogMessage('Loading data...', 'info');
                    }
                };
                
                xhr.onload = function() {
                    const endTime = new Date().getTime();
                    const requestTime = endTime - startTime;
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                        addLogMessage(`Response received (${requestTime}ms)`, 'success');
                        testInProgressElement.style.display = 'none';
                        runTestButton.disabled = false;
                        
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (!data || !data.results) {
                                throw new Error('Invalid response format from server');
                            }
                            
                            // Log test categories
                            addLogMessage('Test results received:', 'success');
                            
                            // Check if raw logs are available
                            if (data.raw_logs) {
                                addLogMessage('=== SERVER-SIDE TEST LOGS ===', 'info');
                                // Split raw logs by line and display each line
                                const logLines = data.raw_logs.split('\n');
                                logLines.forEach(line => {
                                    if (line.includes('Success rate') && line.includes('40%') && line.includes('Failed')) {
                                        addLogMessage(line, 'error');
                                    } else if (line.includes('Failed') || line.includes('Error') || line.includes('Traceback')) {
                                        addLogMessage(line, 'error');
                                    } else if (line.includes('Success') || line.includes('Success)')) {
                                        addLogMessage(line, 'success');
                                    } else if (line.includes('====')) {
                                        addLogMessage(line, 'warning');
                                    } else {
                                        addLogMessage(line, 'info');
                                    }
                                });
                            }
                            
                            displayTestResults(data.results);
                            refreshTimeElement.textContent = `Last updated: ${new Date().toLocaleString()}`;
                            addLogMessage('All test results processed and displayed', 'success');
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            addLogMessage(`Error parsing response: ${e.message}`, 'error');
                            updateResultStatus(`Error parsing response: ${e.message}`, 'all');
                        }
                    } else {
                        console.error('Server error:', xhr.status, xhr.statusText);
                        addLogMessage(`Server returned error: ${xhr.status} ${xhr.statusText}`, 'error');
                        testInProgressElement.style.display = 'none';
                        runTestButton.disabled = false;
                        updateResultStatus(`Server error: ${xhr.status} ${xhr.statusText}`, 'all');
                    }
                };
                
                xhr.ontimeout = function() {
                    console.error('Request timed out');
                    addLogMessage('Request timed out after 120 seconds', 'error');
                    testInProgressElement.style.display = 'none';
                    runTestButton.disabled = false;
                    updateResultStatus('Request timed out - tests may take too long to complete', 'all');
                };
                
                xhr.onerror = function() {
                    console.error('Network error occurred');
                    addLogMessage('Network error occurred', 'error');
                    testInProgressElement.style.display = 'none';
                    runTestButton.disabled = false;
                    
                    // Check if this might be a CORS issue
                    let errorMsg = 'Network error - could not connect to server. Check if server is running and accessible.';
                    
                    if (serverUrl && serverUrl.indexOf(window.location.hostname) === -1) {
                        errorMsg += '\n\nPossible CORS issue: You are trying to connect to a different domain (' + 
                                   serverUrl + '). Make sure the server has CORS enabled with: ' +
                                   'Access-Control-Allow-Origin: *';
                        addLogMessage('Possible CORS issue detected', 'warning');
                        addLogMessage(`Make sure the server at ${serverUrl} has proper CORS headers`, 'warning');
                        addLogMessage('Required header: Access-Control-Allow-Origin: *', 'warning');
                    }
                    
                    updateResultStatus(errorMsg, 'all');
                };
                
                xhr.onloadend = function() {
                    if (xhr.status === 0) {
                        addLogMessage('Request completed with no response', 'warning');
                    } else {
                        addLogMessage(`Request completed with status: ${xhr.status}`, 'info');
                    }
                };
                
                xhr.send();
                addLogMessage('Test request initiated', 'info');
            }
            
            function displayTestResults(results) {
                // Add debug log
                console.log('Results received:', results);
                addLogMessage('Received test results data', 'info');
                
                try {
                    // Process each category and create log entries
                    Object.keys(results).forEach(category => {
                        if (results[category] && results[category].data) {
                            const testsCount = results[category].data.length;
                            addLogMessage(`Processing ${testsCount} tests for category: ${category}`, 'info');
                            
                            // Count successes and failures
                            let successCount = 0;
                            let failureCount = 0;
                            
                            // Process each test in the category
                            results[category].data.forEach(test => {
                                if (test.length >= 4) {
                                    const testNum = test[0];
                                    const testName = test[1];
                                    const required = test[2];
                                    const result = test[3];
                                    
                                    // Determine if test passed or failed
                                    let isPassed = true;
                                    const resultText = String(result).toLowerCase();
                                    const requiredText = String(required).toLowerCase();
                                    
                                    // Special case for percentage tests
                                    if (requiredText.includes('%') && resultText.includes('%')) {
                                        const resultMatch = resultText.match(/(\d+(?:\.\d+)?)%/);
                                        const requiredMatch = requiredText.match(/(\d+(?:\.\d+)?)%/);
                                        
                                        if (resultMatch && requiredMatch) {
                                            const resultPercent = parseFloat(resultMatch[1]);
                                            const requiredPercent = parseFloat(requiredMatch[1]);
                                            
                                            if (resultPercent < requiredPercent) {
                                                isPassed = false;
                                            }
                                        }
                                    }
                                    // Check for failure keywords
                                    else if (resultText.includes('fail') || resultText.includes('below') || 
                                            resultText.includes('error')) {
                                        isPassed = false;
                                    }
                                    
                                    // Log the test result with appropriate status
                                    const logStatus = isPassed ? 'success' : 'error';
                                    const statusText = isPassed ? 'PASS' : 'FAIL';
                                    addLogMessage(`Test ${testNum}: ${testName} - ${statusText} - Required: ${required} - Result: ${result}`, logStatus);
                                    
                                    // Update counters
                                    if (isPassed) {
                                        successCount++;
                                    } else {
                                        failureCount++;
                                    }
                                }
                            });
                            
                            // Log summary for this category
                            const passRate = (successCount / testsCount * 100).toFixed(1);
                            addLogMessage(`${category} summary: ${successCount}/${testsCount} tests passed (${passRate}%)`, 
                                failureCount > 0 ? 'warning' : 'success');
                        }
                    });
                    
                    // Update each table with the results
                    if (results['ESP32 Device Connectivity'] && results['ESP32 Device Connectivity'].data) {
                        updateTable('connectivityTable', results['ESP32 Device Connectivity'].data);
                    } else {
                        addLogMessage('Missing ESP32 Device Connectivity data', 'warning');
                    }
                    
                    if (results['Device Control System'] && results['Device Control System'].data) {
                        updateTable('controlTable', results['Device Control System'].data);
                    } else {
                        addLogMessage('Missing Device Control System data', 'warning');
                    }
                    
                    if (results['Performance Testing'] && results['Performance Testing'].data) {
                        updateTable('performanceTable', results['Performance Testing'].data);
                    } else {
                        addLogMessage('Missing Performance Testing data', 'warning');
                    }
                    
                    if (results['Security Validation'] && results['Security Validation'].data) {
                        updateTable('securityTable', results['Security Validation'].data);
                    } else {
                        addLogMessage('Missing Security Validation data', 'warning');
                    }
                    
                    if (results['Usability Testing'] && results['Usability Testing'].data) {
                        updateTable('usabilityTable', results['Usability Testing'].data);
                    } else {
                        addLogMessage('Missing Usability Testing data', 'warning');
                    }
                    
                    addLogMessage('All tables updated successfully', 'success');
                } catch (error) {
                    console.error('Error in displayTestResults:', error);
                    addLogMessage(`Error displaying test results: ${error.message}`, 'error');
                }
            }
            
            function updateTable(tableId, data) {
                try {
                    const table = document.getElementById(tableId);
                    if (!table) {
                        console.error(`Table with ID ${tableId} not found`);
                        return;
                    }
                    
                    const tbody = table.querySelector('tbody');
                    if (!tbody) {
                        console.error(`Table body not found in table ${tableId}`);
                        return;
                    }
                    
                    // Get category name for logging
                    let categoryName = "Unknown";
                    try {
                        const categoryDiv = table.closest('.test-category');
                        if (categoryDiv) {
                            const titleDiv = categoryDiv.querySelector('.category-title');
                            if (titleDiv) {
                                categoryName = titleDiv.textContent;
                            }
                        }
                    } catch (e) {
                        console.error('Error getting category name:', e);
                    }
                    
                    addLogMessage(`Updating table: ${categoryName}`, 'info');
                    
                    // Clear existing rows
                    tbody.innerHTML = '';
                    
                    // Add new rows
                    data.forEach((row, rowIndex) => {
                        // Create new table row element
                        const tr = document.createElement('tr');
                        
                        // Store cells to access across columns
                        const cells = [];
                        
                        // Add cells
                        row.forEach((cell, index) => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            cells.push(td);
                            tr.appendChild(td);
                        });
                        
                        // Special handling for test results
                        if (cells.length >= 4) {
                            const paramCell = cells[1];
                            const requiredCell = cells[2];
                            const resultCell = cells[3];
                            
                            // Get text values for comparison
                            const paramText = paramCell.textContent.toLowerCase();
                            const requiredText = requiredCell.textContent.toLowerCase();
                            const resultText = resultCell.textContent.toLowerCase();
                            
                            // Handle percentage-based tests
                            if (requiredText.includes('%') && resultText.includes('%')) {
                                try {
                                    // Extract percentages
                                    const resultMatch = resultText.match(/(\d+(?:\.\d+)?)%/);
                                    const requiredMatch = requiredText.match(/(\d+(?:\.\d+)?)%/);
                                    
                                    if (resultMatch && requiredMatch) {
                                        const resultPercent = parseFloat(resultMatch[1]);
                                        const requiredPercent = parseFloat(requiredMatch[1]);
                                        
                                        if (resultPercent >= requiredPercent) {
                                            resultCell.className = 'success';
                                            // Add explicit pass text if not already present
                                            if (!resultText.includes('(pass)')) {
                                                resultCell.textContent += ' (PASS)';
                                            }
                                        } else {
                                            resultCell.className = 'failure';
                                            // Add explicit fail text if not already present
                                            if (!resultText.includes('(fail)')) {
                                                resultCell.textContent += ' (FAIL)';
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error processing percentage test:', e);
                                }
                            }
                            // Handle specific cases like "Reconnection Test" to ensure it shows failure
                            else if (paramText.includes('reconnection test') && resultText.includes('40%') && requiredText.includes('90%')) {
                                resultCell.className = 'failure';
                                resultCell.style.color = 'red';
                                resultCell.style.fontWeight = 'bold';
                                resultCell.textContent += ' (FAIL)';
                            }
                            // Handle "within" or "meets" keywords
                            else if (resultText.includes('within') || resultText.includes('meets')) {
                                resultCell.className = 'success';
                            }
                            // Handle "below" or "fail" keywords
                            else if (resultText.includes('below') || resultText.includes('fail')) {
                                resultCell.className = 'failure';
                            }
                            // Handle time comparisons
                            else if ((resultText.includes('ms') || resultText.includes('s')) && 
                                     (requiredText.includes('ms') || requiredText.includes('s'))) {
                                try {
                                    // Extract numeric values
                                    const resultVal = parseFloat(resultText.match(/(\d+(?:\.\d+)?)/)[1]);
                                    const requiredVal = parseFloat(requiredText.match(/(\d+(?:\.\d+)?)/)[1]);
                                    
                                    // Convert to same unit if needed
                                    let normalizedResultVal = resultVal;
                                    if (resultText.includes('ms') && requiredText.includes('s')) {
                                        normalizedResultVal = resultVal / 1000; // Convert ms to s
                                    } else if (resultText.includes('s') && requiredText.includes('ms')) {
                                        normalizedResultVal = resultVal * 1000; // Convert s to ms
                                    }
                                    
                                    // Check if should be less than or greater than
                                    if (requiredText.includes('<')) {
                                        // Should be less than required
                                        if (normalizedResultVal < requiredVal) {
                                            resultCell.className = 'success';
                                        } else {
                                            resultCell.className = 'failure';
                                        }
                                    } else if (requiredText.includes('>')) {
                                        // Should be greater than required
                                        if (normalizedResultVal > requiredVal) {
                                            resultCell.className = 'success';
                                        } else {
                                            resultCell.className = 'failure';
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error processing time test:', e);
                                }
                            }
                        }
                        
                        // Add the row to the table
                        tbody.appendChild(tr);
                    });
                } catch (e) {
                    console.error('Error updating table:', e);
                    addLogMessage(`Error updating table ${tableId}: ${e.message}`, 'error');
                }
            }
            
            function updateResultStatus(message, table) {
                if (table === 'all') {
                    // Update all tables
                    const tables = ['connectivityTable', 'controlTable', 'performanceTable', 'securityTable', 'usabilityTable'];
                    tables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        const tbody = table.querySelector('tbody');
                        const rows = tbody.querySelectorAll('tr');
                        
                        rows.forEach(row => {
                            const lastCell = row.querySelector('td:last-child');
                            if (lastCell) {
                                lastCell.textContent = message;
                                lastCell.className = '';
                            }
                        });
                    });
                } else {
                    // Update specific table
                    const tbody = document.getElementById(table).querySelector('tbody');
                    const rows = tbody.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const lastCell = row.querySelector('td:last-child');
                        if (lastCell) {
                            lastCell.textContent = message;
                            lastCell.className = '';
                        }
                    });
                }
            }
            
            function exportTestResults() {
                // Create a data object with all test results
                const tables = document.querySelectorAll('table');
                const testData = {};
                
                tables.forEach(table => {
                    const tableId = table.id;
                    const tableData = [];
                    
                    // Get header row
                    const headerRow = table.querySelector('thead tr');
                    const headers = Array.from(headerRow.querySelectorAll('th')).map(th => th.textContent);
                    
                    // Get data rows
                    const dataRows = table.querySelectorAll('tbody tr');
                    dataRows.forEach(row => {
                        const rowData = {};
                        const cells = row.querySelectorAll('td');
                        
                        cells.forEach((cell, index) => {
                            rowData[headers[index]] = cell.textContent;
                        });
                        
                        tableData.push(rowData);
                    });
                    
                    testData[tableId] = tableData;
                });
                
                // Create and download JSON file
                const dataStr = JSON.stringify(testData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'test_results.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
            
            // Function to fetch raw server logs
            function fetchServerLogs() {
                const serverUrl = serverUrlInput.value.trim();
                addLogMessage('Fetching raw server logs...', 'info');
                
                // Construct the URL
                let apiUrl;
                if (serverUrl) {
                    apiUrl = serverUrl + '/api/logs/raw';
                } else {
                    apiUrl = window.location.protocol + '//' + window.location.host + '/api/logs/raw';
                }
                
                // Make the request
                const xhr = new XMLHttpRequest();
                xhr.open('GET', apiUrl, true);
                xhr.timeout = 10000; // 10 second timeout
                
                // Set authentication headers
                const token = localStorage.getItem('token');
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.logs) {
                                addLogMessage('=== RAW SERVER LOGS ===', 'warning');
                                const logLines = data.logs.split('\n');
                                logLines.forEach(line => {
                                    if (line.includes('Failed') || line.includes('Error') || line.includes('Traceback')) {
                                        addLogMessage(line, 'error');
                                    } else if (line.includes('Success') || line.includes('Success)')) {
                                        addLogMessage(line, 'success');
                                    } else if (line.includes('====')) {
                                        addLogMessage(line, 'warning');
                                    } else {
                                        addLogMessage(line, 'info');
                                    }
                                });
                                addLogMessage('=== END RAW SERVER LOGS ===', 'warning');
                            } else {
                                addLogMessage('No raw logs available from server', 'error');
                            }
                        } catch (e) {
                            addLogMessage(`Error parsing log response: ${e.message}`, 'error');
                        }
                    } else {
                        addLogMessage(`Error fetching logs: Server returned ${xhr.status}`, 'error');
                    }
                };
                
                xhr.onerror = function() {
                    addLogMessage('Network error occurred while fetching raw logs', 'error');
                };
                
                xhr.ontimeout = function() {
                    addLogMessage('Timeout while fetching raw logs', 'error');
                };
                
                xhr.send();
            }

            // UI elements for manual log input
            const showManualLogInputButton = document.getElementById('showManualLogInput');
            const manualLogInputDiv = document.getElementById('manualLogInput');
            const rawLogTextArea = document.getElementById('rawLogText');
            const processManualLogsButton = document.getElementById('processManualLogs');

            // Show/hide manual log input
            showManualLogInputButton.addEventListener('click', function() {
                if (manualLogInputDiv.style.display === 'none') {
                    manualLogInputDiv.style.display = 'block';
                    showManualLogInputButton.textContent = 'Hide Input';
                } else {
                    manualLogInputDiv.style.display = 'none';
                    showManualLogInputButton.textContent = 'Paste Server Logs';
                }
            });

            // Process manually pasted logs
            processManualLogsButton.addEventListener('click', function() {
                const logText = rawLogTextArea.value.trim();
                if (logText) {
                    addLogMessage('Processing manually pasted logs...', 'info');
                    displayRawLogs(logText);
                } else {
                    addLogMessage('No log text provided', 'error');
                }
            });

            // Function to display raw logs from text
            function displayRawLogs(logText) {
                // Clear existing logs
                clearTestLogs();
                
                addLogMessage('=== SERVER RAW LOGS ===', 'warning');
                
                // Split by lines and process each line
                const logLines = logText.split('\n');
                logLines.forEach(line => {
                    // Skip empty lines
                    if (!line.trim()) return;
                    
                    if (line.includes('Reconnection Test') && line.includes('40%') && line.includes('Failed')) {
                        addLogMessage(line, 'error');
                    } else if (line.includes('Failed') || line.includes('Error') || line.includes('Traceback')) {
                        addLogMessage(line, 'error');
                    } else if (line.includes('Success') && !line.includes('Failed')) {
                        addLogMessage(line, 'success');
                    } else if (line.includes('===') || line.includes('STARTING') || line.includes('COMPLETED')) {
                        addLogMessage(line, 'warning');
                    } else {
                        addLogMessage(line, 'info');
                    }
                });
                
                addLogMessage('=== END SERVER RAW LOGS ===', 'warning');
                
                // Hide the manual input after processing
                manualLogInputDiv.style.display = 'none';
                showManualLogInputButton.textContent = 'Paste Server Logs';
            }
        });
    </script>
</body>
</html> 